import"../chunks/Bzak7iHL.js";import"../chunks/B8zN5-cI.js";import{o as he}from"../chunks/Dh_dsFNd.js";import{al as we,a0 as Se,aa as Te,af as H,b as x,ae as i,ab as D,a as b,ac as De,ad as o,u as v,g as u,a7 as t,ag as l,n as zt,f as F,c as it,ah as y,aj as X}from"../chunks/BVWwdZHL.js";import{s as _,e as vt}from"../chunks/B8z2uk3R.js";import{i as M}from"../chunks/CcW0RJpt.js";import{e as Y,i as Z,s as Ne,p as Bt}from"../chunks/JKVYAIOI.js";import{s as $,r as S,b as ke,a as Ce}from"../chunks/DkRgT0vW.js";import{b as tt}from"../chunks/Dtqw5nwn.js";import{i as Me}from"../chunks/DiBsknOO.js";import{p as Ae}from"../chunks/DIjW8BnX.js";import{s as Ie}from"../chunks/DwOm6FZI.js";function Oe(K,A,et){var r=we(K,A);r&&r.set&&(K[A]=et,Se(()=>{K[A]=null}))}var je=x("<option> </option>"),Je=x('<div class="val svelte-1xc0b28"> </div> <div class="small muted svelte-1xc0b28"> </div>',1),Ee=x('<div class="val svelte-1xc0b28">—</div> <div class="small muted svelte-1xc0b28">No data</div>',1),Fe=x('<div class="bar svelte-1xc0b28"></div>'),Ge=x('<div class="small muted svelte-1xc0b28">No monthly data</div>'),Le=x("<li> </li>"),Ue=x("<li>No categories</li>"),qe=x('<div class="card small muted svelte-1xc0b28">No transactions found for the selected filters.</div>'),He=x('<div class="err svelte-1xc0b28"> </div>'),Ke=x('<div style="flex:1"><div class="edit-row svelte-1xc0b28"><input type="date" class="svelte-1xc0b28"/> <input type="number" step="0.01" style="width:120px" class="svelte-1xc0b28"/> <input placeholder="Category" style="width:160px" class="svelte-1xc0b28"/> <input placeholder="Subcategory" style="width:140px" class="svelte-1xc0b28"/> <input placeholder="Description" style="flex:1" class="svelte-1xc0b28"/></div> <!></div> <div style="display:flex;flex-direction:column;gap:6px;margin-left:8px"><button class="btn save svelte-1xc0b28"> </button> <button class="btn cancel svelte-1xc0b28">Cancel</button></div>',1),Pe=x('<div style="flex:1"><div style="font-weight:700"> </div> <div class="meta svelte-1xc0b28"> <span class="small muted svelte-1xc0b28"> </span></div></div> <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;margin-left:8px"><div style="font-weight:700"> </div> <div style="display:flex;gap:6px"><button class="btn edit svelte-1xc0b28">Edit</button></div></div>',1),ze=x('<div class="item svelte-1xc0b28"><!></div>'),Be=x('<div class="items svelte-1xc0b28"></div>'),Qe=x('<div class="group svelte-1xc0b28"><div class="group-header svelte-1xc0b28"><div><div style="font-weight:700"> </div> <div class="small muted svelte-1xc0b28"> </div></div> <div style="text-align:right"><div style="font-weight:700"> </div> <div class="small muted svelte-1xc0b28"> </div></div></div> <!></div>'),Re=x('<div class="container svelte-1xc0b28"><h1 style="margin-bottom:0.6rem">Dashboard — Transactions</h1> <div class="top-grid svelte-1xc0b28"><div class="card svelte-1xc0b28"><form class="filters-form svelte-1xc0b28" method="get" style="display:flex;flex-direction:column;gap:0.6rem"><div style="display:flex;gap:0.5rem;flex-wrap:wrap"><div class="filters svelte-1xc0b28"><label class="small muted svelte-1xc0b28">From</label> <input type="date" name="startDate" class="svelte-1xc0b28"/> <label class="small muted svelte-1xc0b28">To</label> <input type="date" name="endDate" class="svelte-1xc0b28"/> <label class="small muted svelte-1xc0b28">Account</label> <select name="accountId" class="svelte-1xc0b28"><option>All</option><!></select> <label class="small muted svelte-1xc0b28">Categories (comma)</label> <input type="text" name="categories" placeholder="food,transport" class="svelte-1xc0b28"/> <label class="small muted svelte-1xc0b28">Min</label> <input type="number" step="0.01" name="minAmount" placeholder="0" class="svelte-1xc0b28"/> <label class="small muted svelte-1xc0b28">Max</label> <input type="number" step="0.01" name="maxAmount" placeholder="0" class="svelte-1xc0b28"/></div></div> <div style="display:flex;gap:0.5rem;justify-content:flex-end"><button class="small svelte-1xc0b28" type="submit" style="padding:0.5rem 0.75rem;border-radius:8px;background:#3b82f6;color:white;border:none">Apply</button> <a href="/dashboard" class="small svelte-1xc0b28" style="padding:0.5rem 0.75rem;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)">Clear</a></div></form> <div style="margin-top:0.8rem" class="cards svelte-1xc0b28"><div class="stat svelte-1xc0b28"><h3 class="svelte-1xc0b28">Total Spent</h3> <div class="val svelte-1xc0b28"> </div> <div class="small muted svelte-1xc0b28"> </div></div> <div class="stat svelte-1xc0b28"><h3 class="svelte-1xc0b28">Total Income</h3> <div class="val svelte-1xc0b28"> </div> <div class="small muted svelte-1xc0b28"> </div></div> <div class="stat svelte-1xc0b28"><h3 class="svelte-1xc0b28">Top Category</h3> <!></div></div></div> <div class="card svelte-1xc0b28"><h3 class="small muted svelte-1xc0b28" style="margin:0 0 0.5rem 0">Monthly (recent)</h3> <div class="chart svelte-1xc0b28" aria-hidden="true"><!></div> <div style="margin-top:0.6rem"><h4 style="margin:0 0 0.35rem 0">Top categories</h4> <ul class="small muted svelte-1xc0b28"><!></ul></div></div></div> <div class="list svelte-1xc0b28"><!></div></div>');function ia(K,A){Te(A,!1);const et=async({locals:e})=>{if(!e.user)return{groupedTransactions:[]};const{data:s,error:d}=await Ie.from("transactions").select("*").eq("user_id",e.user.id).order("date",{ascending:!1});if(d)return console.error("Failed to load transactions for dashboard:",d),{groupedTransactions:[]};const c=s??[],a={};for(const m of c){const p=m.date?String(m.date).split("T")[0]:"unknown";a[p]||(a[p]=[]),a[p].push(m)}return{groupedTransactions:Object.entries(a).map(([m,p])=>{const T=p.reduce((j,k)=>j+(Number(k.amount)||0),0);return{date:m,total:T,items:p}}).sort((m,p)=>m.date<p.date?1:m.date>p.date?-1:0)}};let r=Ae(A,"data",8),I=H(r().groupedTransactions?JSON.parse(JSON.stringify(r().groupedTransactions)):[]),w=H(new Set),at=H(null),n=H(null),P=null,z=H(!1),O=H("");he(()=>{var e;(e=r().groupedTransactions)!=null&&e[0]&&t(w).add(r().groupedTransactions[0].date)});const N=e=>e.toLocaleString(void 0,{style:"currency",currency:"USD",minimumFractionDigits:2}),Qt=e=>{try{return new Date(e).toLocaleDateString(void 0,{weekday:"short",year:"numeric",month:"short",day:"numeric"})}catch{return e}};function Rt(e){t(w).has(e)?t(w).delete(e):t(w).add(e),y(w,new Set(t(w)))}function Vt(e,s){y(at,e.id),y(n,{id:e.id,date:e.date?String(e.date).slice(0,10):"",amount:Number(e.amount)??0,category:e.category??"",subcategory:e.subcategory??"",description:e.description??"",account_id:e.account_id??e.accountId??null}),P=s,y(O,"")}function At(){y(at,null),y(n,null),P=null,y(O,"")}async function Wt(){if(t(n)){y(z,!0),y(O,"");try{const e=await fetch("/budgeting/api/transactions",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t(n))});if(!e.ok){const d=await e.text();y(O,d||`Save failed (${e.status})`),y(z,!1);return}const s=t(n).date;if(P&&s!==P){window.location.href=window.location.pathname+window.location.search;return}for(const d of t(I))if(d.date===P){const c=d.items.findIndex(a=>a.id===t(n).id);if(c>-1){const a=Number(d.items[c].amount)||0;d.items[c]={...d.items[c],amount:t(n).amount,date:t(n).date,category:t(n).category,subcategory:t(n).subcategory,description:t(n).description,account_id:t(n).account_id},d.total=d.total-a+Number(t(n).amount||0)}break}y(I,JSON.parse(JSON.stringify(t(I)))),At()}catch(e){y(O,String(e))}finally{y(z,!1)}}}Me();var ot=Re(),dt=o(i(ot),2),nt=i(dt),ct=i(nt),It=i(ct),Ot=i(It),ut=o(i(Ot),2);S(ut);var mt=o(ut,4);S(mt);var bt=o(mt,4),_t=i(bt);_t.value=_t.__value="";var Xt=o(_t);Y(Xt,1,()=>(u(r()),v(()=>r().accounts)),Z,(e,s)=>{var d=je(),c=i(d,!0);l(d);var a={};D(()=>{ke(d,(t(s),u(r()),v(()=>{var f;return t(s).id===((f=r().filters)==null?void 0:f.accountId)}))),_(c,(t(s),v(()=>t(s).name))),a!==(a=(t(s),v(()=>t(s).id)))&&(d.value=(d.__value=(t(s),v(()=>t(s).id)))??"")}),b(e,d)}),l(bt);var pt=o(bt,4);S(pt);var ft=o(pt,4);S(ft);var jt=o(ft,4);S(jt),l(Ot),l(It),zt(2),l(ct);var Jt=o(ct,2),xt=i(Jt),gt=o(i(xt),2),Yt=i(gt,!0);l(gt);var Et=o(gt,2),Zt=i(Et);l(Et),l(xt);var yt=o(xt,2),ht=o(i(yt),2),$t=i(ht,!0);l(ht);var Ft=o(ht,2),te=i(Ft);l(Ft),l(yt);var Gt=o(yt,2),ee=o(i(Gt),2);{var ae=e=>{var s=Je(),d=F(s),c=i(d,!0);l(d);var a=o(d,2),f=i(a,!0);l(a),D(m=>{_(c,(u(r()),v(()=>r().topCategories[0].category))),_(f,m)},[()=>(u(r()),v(()=>N(r().topCategories[0].total)))]),b(e,s)},se=e=>{var s=Ee();zt(2),b(e,s)};M(ee,e=>{u(r()),v(()=>{var s;return(s=r().topCategories)==null?void 0:s.length})?e(ae):e(se,!1)})}l(Gt),l(Jt),l(nt);var Lt=o(nt,2),wt=o(i(Lt),2),re=i(wt);{var le=e=>{var s=it(),d=F(s);Y(d,1,()=>(u(r()),v(()=>r().monthlySeries)),Z,(c,a)=>{var f=it(),m=F(f);{var p=T=>{var j=Fe();D((k,St)=>{Ne(j,`height: ${k??""}%`),Ce(j,"title",`${t(a),v(()=>t(a).month)??""}: ${St??""}`)},[()=>(t(a),u(r()),v(()=>Math.max(6,Math.round(Math.abs(t(a).total)/Math.max(...r().monthlySeries.map(k=>Math.abs(k.total),0))*100)))),()=>(t(a),v(()=>N(t(a).total)))]),b(T,j)};M(m,T=>{u(r()),v(()=>r().monthlySeries.length)&&T(p)})}b(c,f)}),b(e,s)},ie=e=>{var s=Ge();b(e,s)};M(re,e=>{u(r()),v(()=>{var s;return(s=r().monthlySeries)==null?void 0:s.length})?e(le):e(ie,!1)})}l(wt);var Ut=o(wt,2),qt=o(i(Ut),2),ve=i(qt);{var oe=e=>{var s=it(),d=F(s);Y(d,1,()=>(u(r()),v(()=>r().topCategories)),Z,(c,a)=>{var f=Le(),m=i(f);l(f),D(p=>_(m,`${t(a),v(()=>t(a).category)??""} — ${p??""}`),[()=>(t(a),v(()=>N(t(a).total)))]),b(c,f)}),b(e,s)},de=e=>{var s=Ue();b(e,s)};M(ve,e=>{u(r()),v(()=>{var s;return(s=r().topCategories)==null?void 0:s.length})?e(oe):e(de,!1)})}l(qt),l(Ut),l(Lt),l(dt);var Ht=o(dt,2),ne=i(Ht);{var ce=e=>{var s=qe();b(e,s)},ue=e=>{var s=it(),d=F(s);Y(d,1,()=>t(I),Z,(c,a)=>{var f=Qe(),m=i(f),p=i(m),T=i(p),j=i(T,!0);l(T);var k=o(T,2),St=i(k);l(k),l(p);var Kt=o(p,2),Tt=i(Kt),me=i(Tt,!0);l(Tt);var Pt=o(Tt,2),be=i(Pt,!0);l(Pt),l(Kt),l(m);var _e=o(m,2);{var pe=B=>{var Q=Be();Y(Q,5,()=>(t(a),v(()=>t(a).items)),Z,(Dt,g)=>{var Nt=ze(),fe=i(Nt);{var xe=G=>{var R=Ke(),J=F(R),E=i(J),V=i(E);S(V);var L=o(V,2);S(L);var U=o(L,2);S(U);var q=o(U,2);S(q);var st=o(q,2);S(st),l(E);var rt=o(E,2);{var W=h=>{var Mt=He(),ye=i(Mt,!0);l(Mt),D(()=>_(ye,t(O))),b(h,Mt)};M(rt,h=>{t(O)&&h(W)})}l(J);var lt=o(J,2),C=i(lt),kt=i(C,!0);l(C);var Ct=o(C,2);l(lt),D(()=>{C.disabled=t(z),_(kt,t(z)?"Saving…":"Save")}),tt(V,()=>t(n).date,h=>X(n,t(n).date=h)),tt(L,()=>t(n).amount,h=>X(n,t(n).amount=h)),tt(U,()=>t(n).category,h=>X(n,t(n).category=h)),tt(q,()=>t(n).subcategory,h=>X(n,t(n).subcategory=h)),tt(st,()=>t(n).description,h=>X(n,t(n).description=h)),vt("click",C,Bt(Wt)),vt("click",Ct,Bt(At)),b(G,R)},ge=G=>{var R=Pe(),J=F(R),E=i(J),V=i(E);l(E);var L=o(E,2),U=i(L),q=o(U),st=i(q,!0);l(q),l(L),l(J);var rt=o(J,2),W=i(rt),lt=i(W,!0);l(W);var C=o(W,2),kt=i(C);l(C),l(rt),D(Ct=>{_(V,`${t(g),v(()=>t(g).category??"—")??""}${t(g),v(()=>t(g).subcategory?` › ${t(g).subcategory}`:"")??""}`),_(U,`${t(g),v(()=>t(g).description??"")??""} · `),_(st,(t(g),v(()=>t(g).account_id??""))),_(lt,Ct)},[()=>(t(g),v(()=>N(Number(t(g).amount)||0)))]),vt("click",kt,()=>Vt(t(g),t(a).date)),b(G,R)};M(fe,G=>{t(at),t(g),v(()=>t(at)===t(g).id)?G(xe):G(ge,!1)})}l(Nt),b(Dt,Nt)}),l(Q),b(B,Q)};M(_e,B=>{t(w),t(a),v(()=>t(w).has(t(a).date))&&B(pe)})}l(f),D((B,Q,Dt)=>{_(j,B),_(St,`${t(a),v(()=>t(a).items.length)??""} item${t(a),v(()=>t(a).items.length>1?"s":"")??""}`),_(me,Q),_(be,Dt)},[()=>(t(a),v(()=>Qt(t(a).date))),()=>(t(a),v(()=>N(t(a).total))),()=>(t(w),t(a),v(()=>t(w).has(t(a).date)?"Hide":"Show"))]),vt("click",m,()=>Rt(t(a).date)),b(c,f)}),b(e,s)};M(ne,e=>{t(I),v(()=>!t(I)||t(I).length===0)?e(ce):e(ue,!1)})}return l(Ht),l(ot),D((e,s,d,c)=>{$(ut,(u(r()),v(()=>{var a;return((a=r().filters)==null?void 0:a.startDate)??""}))),$(mt,(u(r()),v(()=>{var a;return((a=r().filters)==null?void 0:a.endDate)??""}))),$(pt,e),$(ft,(u(r()),v(()=>{var a;return((a=r().filters)==null?void 0:a.minAmount)??""}))),$(jt,(u(r()),v(()=>{var a;return((a=r().filters)==null?void 0:a.maxAmount)??""}))),_(Yt,s),_(Zt,`${u(r()),v(()=>{var a;return((a=r().totals)==null?void 0:a.transactionsCount)??0})??""} txns`),_($t,d),_(te,`Net: ${c??""}`)},[()=>(u(r()),v(()=>{var e,s,d,c;return((d=(s=(e=r().filters)==null?void 0:e.categories)==null?void 0:s.join)==null?void 0:d.call(s,","))??(((c=r().filters)==null?void 0:c.categories)||"")})),()=>(u(r()),v(()=>{var e;return N(((e=r().totals)==null?void 0:e.totalSpent)??0)})),()=>(u(r()),v(()=>{var e;return N(((e=r().totals)==null?void 0:e.totalIncome)??0)})),()=>(u(r()),v(()=>{var e;return N(((e=r().totals)==null?void 0:e.net)??0)}))]),b(K,ot),Oe(A,"load",et),De({load:et})}export{ia as component};
